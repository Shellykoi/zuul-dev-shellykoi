# API端点问题修复指南

## 问题描述
测试API时返回"未知的API端点"错误。

## 修复步骤

### 1. 重新编译代码
```powershell
# 清理旧的编译文件
Remove-Item -Recurse -Force out -ErrorAction SilentlyContinue

# 创建输出目录
New-Item -ItemType Directory -Force -Path out

# 编译所有Java文件
javac -d out -encoding UTF-8 -cp out src/cn/edu/whut/sept/zuul/*.java
```

### 2. 重启服务器
停止当前运行的服务器（按 Ctrl+C），然后重新启动：
```powershell
java -cp out cn.edu.whut.sept.zuul.GameWebServer
```

### 3. 运行诊断脚本
```powershell
.\diagnose_api.ps1
```

### 4. 检查服务器控制台输出
启动服务器后，查看控制台输出。当有API请求时，你应该看到：
- 原始请求行
- 解析后的方法和路径
- 路径规范化过程
- 路径匹配检查结果

### 5. 如果问题仍然存在

#### 检查点1: 路径格式
确保请求路径是 `/api/login` 而不是 `/api/login/` 或其他格式。

#### 检查点2: HTTP方法
确保使用正确的HTTP方法：
- `/api/login` - POST
- `/api/register` - POST
- `/api/command` - POST
- `/api/status` - GET

#### 检查点3: 服务器端口
确保测试脚本使用的端口与服务器实际运行的端口一致。

#### 检查点4: 查看详细错误信息
如果错误响应包含 `debug` 字段，检查：
- `originalPath`: 原始路径
- `normalizedPath`: 规范化后的路径
- `method`: HTTP方法

## 已修复的问题

1. **路径规范化改进**
   - 添加了URL解码处理
   - 移除了不可见字符
   - 改进了路径清理逻辑

2. **请求解析改进**
   - 使用正则表达式分割请求行
   - 添加了更多的调试输出
   - 改进了错误处理

3. **调试信息增强**
   - 输出原始请求行
   - 输出解析后的方法和路径
   - 输出路径规范化过程
   - 输出详细的匹配检查结果

## 测试命令

```powershell
# 测试登录API
$body = @{username="koi"; password="123456"} | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:8080/api/login" -Method POST -Body $body -ContentType "application/json"
```

## 常见问题

### Q: 为什么还是返回"未知的API端点"？
A: 请确保：
1. 服务器已重新编译
2. 服务器已重启
3. 检查服务器控制台的调试输出
4. 确认路径和方法匹配

### Q: 如何查看服务器接收到的实际请求？
A: 查看服务器控制台输出，应该能看到：
```
原始请求行: [POST /api/login HTTP/1.1]
解析后 - 方法: [POST], 路径: [/api/login]
=== API请求 ===
...
```

### Q: 路径规范化输出什么？
A: 如果路径被修改，会输出：
```
路径规范化: [原始路径] -> [规范化后的路径]
```

